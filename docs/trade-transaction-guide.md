# 거래 시스템 가이드

## 개요
TimeMarket의 거래 시스템은 사용자 간에 시간을 안전하게 거래할 수 있도록 합니다. 양쪽 사용자가 모두 수락했을 때만 거래가 성사되며, 잔액이 부족한 경우 자동으로 거래가 거절됩니다.

## 거래 흐름

### 1. 거래 요청 생성
```http
POST /api/chat/rooms/{room_id}/trade/
```

**요청 데이터:**
```json
{
    "proposed_price": 15000,
    "proposed_hours": 3.5,
    "message": "도움 요청드립니다"
}
```

### 2. 거래 수락
```http
PATCH /api/chat/trade/{trade_id}/
```

**요청자가 수락:**
```json
{
    "requester_accepted": true
}
```

**수신자가 수락:**
```json
{
    "receiver_accepted": true
}
```

### 3. 거래 성사
양쪽 모두 수락하면 자동으로 거래가 처리됩니다.

## 거래 타입

### Sale (시간 판매)
- **판매자(게시글 작성자)**: 자신의 시간/노동을 제공하고 → **돈(시간) 받음** 💰
- **구매자(거래 요청자)**: 돈(시간)을 지불하고 → 판매자의 서비스 받음
- **흐름:** 구매자의 시간(돈) → 판매자에게 전달

**예시:** "컴퓨터 수리 도와드립니다 (시간당 10,000원)"
```
게시글 작성자(user1/판매자) - balance: 5시간
거래 요청자(user2/구매자) - balance: 10시간
거래 시간: 3시간

거래 후:
user1 - balance: 8시간 (5 + 3)  ← 판매자가 돈(시간) 받음
user2 - balance: 7시간 (10 - 3) ← 구매자가 돈(시간) 지불
```

### Request (구인)
- **게시글 작성자**: 돈(시간)을 지불하고 → 서비스 받음
- **거래 요청자**: 자신의 시간/노동을 제공하고 → **돈(시간) 받음** 💰
- **흐름:** 게시글 작성자의 시간(돈) → 요청자에게 전달

**예시:** "개발자 구합니다 (시간당 20,000원 드립니다)"
```
게시글 작성자(user1) - balance: 10시간
거래 요청자(user2) - balance: 5시간
거래 시간: 4시간

거래 후:
user1 - balance: 6시간 (10 - 4)  ← 게시글 작성자가 돈(시간) 지불
user2 - balance: 9시간 (5 + 4)   ← 요청자가 돈(시간) 받음
```

### 중요: 시간이 곧 돈(화폐)입니다
TimeMarket에서 "시간"은 화폐의 역할을 합니다. 
- `proposed_price`: 참고 가격 (실제 거래 금액은 아님)
- `proposed_hours`: 실제로 이동하는 시간(돈)의 양
- 거래 시 `proposed_hours`만큼 시간이 지불자 → 수령자로 이동합니다

## 잔액 검증

### 충분한 잔액
제공자의 잔액이 요청 시간 이상일 경우:
- ✅ 거래 성사
- 지갑 잔액 자동 차감/증가
- 거래 내역 기록
- 상태: `completed`

### 부족한 잔액
제공자의 잔액이 요청 시간 미만일 경우:
- ❌ 거래 거절
- 지갑 잔액 변화 없음
- 상태: `rejected`

**응답 예시:**
```json
{
    "error": [
        "user1님의 잔액이 부족하여 거래가 거절되었습니다. 필요: 5.00시간, 현재 잔액: 2.00시간"
    ]
}
```

## 거래 상태

| 상태 | 설명 |
|------|------|
| `pending` | 대기중 - 수락 대기 |
| `accepted` | 수락됨 - 한쪽만 수락 |
| `rejected` | 거절됨 - 잔액 부족 등의 이유로 거절 |
| `completed` | 완료됨 - 양쪽 수락 및 거래 완료 |
| `cancelled` | 취소됨 - 사용자가 취소 |

## 안전장치

### 1. 트랜잭션 보장
- 데이터베이스 트랜잭션으로 원자성 보장
- 거래 중 오류 발생 시 자동 롤백

### 2. 동시성 제어
- `select_for_update()`를 사용한 락 처리
- 동시 거래 시도 시 안전하게 처리

### 3. 거래 내역 기록
모든 거래는 Transaction 테이블에 기록됩니다:
```python
{
    "wallet": wallet_id,
    "transaction_type": "withdraw" | "deposit",
    "amount": proposed_hours,
    "note": "거래 내역 설명",
    "timestamp": "2025-10-12T12:00:00Z"
}
```

### 4. 상태 검증
- 이미 완료/거절/취소된 거래는 수정 불가
- 권한이 없는 사용자는 거래 수정 불가

## API 응답 예시

### 성공적인 거래
```json
{
    "id": 1,
    "room": 5,
    "post": {
        "id": 10,
        "title": "컴퓨터 수리 도움",
        "type": "sale"
    },
    "requester": {
        "id": 2,
        "nickname": "user2",
        "email": "user2@example.com"
    },
    "receiver": {
        "id": 1,
        "nickname": "user1",
        "email": "user1@example.com"
    },
    "proposed_price": "15000.00",
    "proposed_hours": "3.00",
    "message": "도움 요청드립니다",
    "status": "completed",
    "requester_accepted": true,
    "receiver_accepted": true,
    "created_at": "2025-10-12T10:00:00Z",
    "updated_at": "2025-10-12T12:00:00Z"
}
```

## 테스트

거래 시스템의 모든 기능은 테스트로 검증됩니다:

```bash
python manage.py test chat.tests.test_trade_views
```

**테스트 커버리지:**
- ✅ 잔액이 충분한 경우 거래 성사
- ✅ 잔액이 부족한 경우 거래 거절
- ✅ Sale 타입 거래
- ✅ Request 타입 거래
- ✅ 완료된 거래 수정 불가
- ✅ 거래 내역 기록
- ✅ 권한 검증

## 주의사항

1. **지갑이 없는 경우:** 첫 거래 시도 시 자동으로 지갑이 생성됩니다 (초기 잔액: 0)
2. **초기 잔액:** 관리자가 사용자에게 초기 시간을 부여해야 거래가 가능합니다
3. **동시 거래:** 한 사용자가 여러 거래를 동시에 수락하면 잔액이 부족할 수 있습니다
4. **취소 불가:** 거래가 완료되면 취소할 수 없습니다

## 향후 개선 사항

- [ ] 거래 취소 기능
- [ ] 거래 이의 제기 시스템
- [ ] 자동 환불 시스템
- [ ] 거래 평가/리뷰 시스템

